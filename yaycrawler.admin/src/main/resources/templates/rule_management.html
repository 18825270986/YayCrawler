<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.springframework.org/schema/jdbc">
<head xmlns:th="http://www.thymeleaf.org" th:include="master::head">
    <title>页面抽取规则配置</title>

</head>
<body>
<div class="container">
    <div class="row">
        <!--<div class="col-md-4">-->
        <!--</div>-->
        <div class="col-md-12">
            <div id="toolbar" class="btn-group">
                <button id="btn_add" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
                </button>
                <!--<button id="btn_edit" type="button" class="btn btn-default">-->
                <!--<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改-->
                <!--</button>-->
                <button id="btn_delete" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
                </button>
            </div>
            <table id="tb_sites"></table>
        </div>


    </div>
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="divModal" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 800px;height:auto;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">×
                    </button>
                    <h4 class="modal-title" id="modalLabel">
                    </h4>
                </div>
                <div class="modal-body" >
                    <iframe src="" style="width:100%;height:460px;border: none">
                    </iframe>
                </div>
                <!--<div class="modal-footer">-->
                <!--<button type="button" class="btn btn-default"-->
                <!--data-dismiss="modal">-->
                <!--关闭-->
                <!--</button>-->
                <!--<button id="btnSiteSubmit" type="button" class="btn btn-primary">-->
                <!--保存-->
                <!--</button>-->
                <!--</div>-->
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


    <div th:include="master::itemDel"></div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    $(function () {
                $("#btnSubmit").click(function () {
                    $("#cookieForm").ajaxSubmit({
                        success: function (data) {
                            $('#cookieAddModal').modal('hide');
                            $('#tb_sites').bootstrapTable('refresh');
                        }
                    });
                });
                $("#btnSiteSubmit").click(function () {
                    $("#siteForm").ajaxSubmit({
                        success: function (data) {
                            $('#divModal').modal('hide');
                            $('#tb_sites').bootstrapTable('refresh');
                        }
                    });
                });

                $("#btn_add").click(function () {
                    $("#modalLabel").html("添加测试Page");
                    $('#divModal iframe').attr("src", "addPageInfo");
                    $('#divModal').modal({
                        keyboard: false
                    });
                });
                $("#btn_delete").click(function () {
                    delItem(function () {
                        debugger
                        var selectedRows = $('#tb_sites').bootstrapTable('getSelections');
                        var selectedIds = [];
                        $.each(selectedRows, function (i, item) {
                            selectedIds.push(item.id);
                        });
                        if (selectedIds.length == 0) return false;

                        $.ajax({
                            type: "Post",
                            cache: false,
                            contentType: "application/json",
                            url: global.contextPath + "/deleteSites",
                            data: JSON.stringify(selectedIds),
                            dataType: 'json',
                            success: function (result) {     //回调函数，result，返回值
                                if (result == true)
                                    $('#tb_sites').bootstrapTable('refresh');
                                else
                                    alert("删除失败");
                            },
                            error: function (msg) {
                                alert(JSON.stringify(msg));
                            }
                        });
                    });
                });

                //1.初始化Table
                var TableInit = function () {
                    var oTableInit = new Object();
                    //初始化Table
                    oTableInit.Init = function () {
                        $('#tb_sites').bootstrapTable($.extend(global.bootstrapTableOptions, {
                                    url: global.contextPath + '/queryPageInfos',
                                    columns: [{
                                        checkbox: true
                                    }, {
                                        field: 'pageUrl',
                                        title: '页面Url'
                                    }, {
                                        field: 'urlRgx',
                                        title: 'Url匹配正则表达式',
                                        editable: {
                                            type: 'text'
                                        }
                                    }, {
                                        field: 'method',
                                        title: '请求方式',
                                        editable: {
                                            type: 'text'
                                        }
                                    }, {
                                        field: 'paramsJson',
                                        title: '请求参数',
                                        editable: {
                                            type: 'text'
                                        }
                                    },
                                        {
                                            field: 'action',
                                            title: '操作',
                                            formatter: oTableInit.actionFormatter,
                                            events: oTableInit.actionEvents
                                        }
                                    ],
                                    //注册加载子表的事件。注意下这里的三个参数！
                                    onExpandRow: function (index, row, $detail) {
                                        var cookieList = row.cookieList;
                                        if (!cookieList || cookieList.length == 0) return;

                                        var tdDom = '<table class="table table-bordered table-condensed">' +
                                                '<thead>' +
                                                '<tr>' +
                                                '<th>序号</th>' +
                                                '<th>所属域名</th>' +
                                                '<th>cookie</th>' +
                                                '<th>创建时间</th>' +
                                                '</tr>' +
                                                '</thead>' +
                                                '<tbody>';
                                        $.each(cookieList, function (index, item) {
                                            tdDom += '<tr><td>' + index + '</td><td>' + item.domain +
                                                    '</td><td>' + item.cookie + '</td><td>' + item.createdDate + '</td></tr>';
                                        });
                                        tdDom += '</tbody></table>';
                                        $detail.append(tdDom).fadeIn(500);
                                    }
                                }
                        ));
                    };
                    oTableInit.actionFormatter = function (value, row, index) {
                        return [
                            '<a  href="javascript:void(0)" class="addCookie btn btn-sm green" title="添加cookie">',
                            '<i class="fa fa-plus">添加cookie</i>',
                            '</a>'
                        ].join('');
                    };
                    oTableInit.actionEvents = {
                        'click .addCookie': function (e, value, row, index) {
                            $("#cookieForm #siteId").val(row.id);
                            $("#cookieForm #domain").val(row.domain);
                            $('#cookieAddModal').modal({
                                keyboard: false
                            });
                        }
                    };
                    return oTableInit;
                };
                var oTable = new TableInit();
                oTable.Init();
            }
    );
    /*]]>*/
</script>

</body>
</html>